<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מקצר כתובות URL</title>
    <style>
        /* ... (same styles as before) ... */
    </style>
</head>
<body>
    <!-- ... (same HTML structure as before) ... -->

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzj5eYTd-X8B_tzkJGYgvsdqhqX4d66Mbkgp16N5RuZTlLvc6IcLj-QgE4KUKDu45J5WQ/exec';
        const BASE_URL = 'https://yosefgli.github.io/1/3?short=';
        
        // פונקציה חדשה לתיקון URL
        function formatURL(url) {
            url = url.trim();
            
            // אם אין פרוטוקול, נוסיף https://
            if (!url.match(/^https?:\/\//i)) {
                // אם יש www. בהתחלה, נוסיף רק פרוטוקול
                if (url.startsWith('www.')) {
                    url = 'https://' + url;
                } else {
                    // אם אין www., נוסיף פרוטוקול וwww.
                    url = 'https://www.' + url;
                }
            }
            
            // הסרת / בסוף אם קיים
            return url.replace(/\/$/, '');
        }

        // שיפור ביצועים - שמירת תוצאות בדיקת סיומת במטמון
        const slugCache = new Map();
        let lastCheck = 0;
        const CACHE_DURATION = 30000; // 30 שניות

        async function checkSlug() {
            const slug = document.getElementById('customSlug').value;
            if (!slug) {
                alert('נא להזין סיומת');
                return;
            }
            
            document.getElementById('loader').style.display = 'block';
            document.getElementById('slugStatus').textContent = 'בודק סיומת...';
            
            try {
                const now = Date.now();
                // בדיקה האם צריך לרענן את המטמון
                if (now - lastCheck > CACHE_DURATION) {
                    const response = await fetch(`${SCRIPT_URL}?action=checkSlug`);
                    const data = await response.json();
                    data.slugs.forEach(s => slugCache.set(s, true));
                    lastCheck = now;
                }
                
                const exists = slugCache.has(slug);
                
                if (exists) {
                    document.getElementById('slugStatus').textContent = 'סיומת תפוסה';
                    document.getElementById('createButton').disabled = true;
                } else {
                    document.getElementById('slugStatus').textContent = 'סיומת תקינה';
                    document.getElementById('createButton').disabled = false;
                }
            } catch (error) {
                document.getElementById('slugStatus').textContent = 'שגיאה בבדיקת הסיומת';
                console.error('Error:', error);
            }
            
            document.getElementById('loader').style.display = 'none';
        }
        
        async function createShortUrl() {
            const longUrlInput = document.getElementById('longUrl');
            const slug = document.getElementById('customSlug').value;
            
            if (!longUrlInput.value || !slug) {
                alert('נא למלא את כל השדות');
                return;
            }
            
            // תיקון ה-URL לפני השמירה
            const formattedUrl = formatURL(longUrlInput.value);
            longUrlInput.value = formattedUrl; // עדכון הערך בשדה הקלט
            
            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        longUrl: formattedUrl,
                        slug: slug
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const shortUrl = BASE_URL + slug;
                    document.getElementById('shortUrl').value = shortUrl;
                    document.getElementById('result').style.display = 'block';
                    // עדכון המטמון
                    slugCache.set(slug, true);
                } else {
                    alert('שגיאה ביצירת הקישור המקוצר');
                }
            } catch (error) {
                alert('שגיאה ביצירת הקישור המקוצר');
                console.error('Error:', error);
            }
        }
        
        function copyToClipboard() {
            const shortUrl = document.getElementById('shortUrl');
            shortUrl.select();
            document.execCommand('copy');
            alert('הקישור הועתק ללוח');
        }
    </script>
</body>
</html>
